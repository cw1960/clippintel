"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "validateToken", {
    enumerable: true,
    get: function() {
        return validateToken;
    }
});
const _core = require("@whop-apps/core");
const _jose = require("jose");
const _errors = require("./errors");
const _getToken = require("./getToken");
async function validateToken({ jwk, dontThrow, appId: _appId, ...rest }) {
    try {
        const tokenString = (0, _getToken.getToken)(rest);
        const jwkString = jwk ?? _core.WhopEnvStore.get(_core.WhopEnv.JWK_PK);
        const key = await (0, _jose.importJWK)(JSON.parse(jwkString), "ES256").catch(()=>{
            throw new _errors.AuthError("invalid-key");
        });
        const token = await (0, _jose.jwtVerify)(tokenString, key, {
            issuer: "urn:whopcom:exp-proxy"
        }).catch((_e)=>{
            // if (e instanceof JWTExpired) throw new AuthError('token-expired');
            throw new _errors.AuthError("token-invalid");
        });
        if (!(token.payload.sub && token.payload.aud) || Array.isArray(token.payload.aud)) {
            throw new _errors.AuthError("token-invalid");
        }
        const appId = _core.WhopEnvStore.tryGet(_core.WhopEnv.APP_ID, _appId ?? undefined);
        if (appId && token.payload.aud !== appId) throw new _errors.AuthError("invalid-app-id");
        return {
            appId: token.payload.aud,
            userId: token.payload.sub
        };
    } catch (error) {
        // This is safe because we know that the user specified dontThrow as true, hence return type may be null
        if (dontThrow) return null;
        throw error;
    }
}
